package TD5;

import java.io.FileInputStream;
import java.io.FileNotFoundException;
import org.apache.jena.query.Query;
import org.apache.jena.query.QueryExecution;
import org.apache.jena.query.QueryExecutionFactory;
import org.apache.jena.query.QueryFactory;
import org.apache.jena.query.ResultSet;
import org.apache.jena.query.ResultSetFormatter;
import org.apache.jena.rdf.model.Model;
import org.apache.jena.rdf.model.ModelFactory;

import jade.core.AID;
import jade.core.Agent;
import jade.core.behaviours.CyclicBehaviour;
import jade.core.behaviours.OneShotBehaviour;
import jade.lang.acl.ACLMessage;

public class PropagateSparql extends Agent {
	
	private static final long serialVersionUID = -9074818395516468244L;

	public void setup() {
		System.out.println(getLocalName() + "--> installed");
		addBehaviour(new OneShotBehaviour() {
			//Envoi de la requete sparql vers l'Agent KB.
			private static final long serialVersionUID = 1743225391381670328L;
			
			@Override
			public void action() {
				String query = "requete.sparql";
				ACLMessage msg=new ACLMessage(ACLMessage.REQUEST);
				msg.setContent(query);
				msg.addReceiver(new AID("Recherche",AID.ISLOCALNAME));
				send(msg);
			}
		});
		addBehaviour(new CyclicBehaviour() {

			private static final long serialVersionUID = 1743225391371670328L;
			
			@Override
			public void action() {
				ACLMessage msg=receive();
				if(msg!=null){
					System.out.println(getLocalName() + " reçoit : "+msg.getContent());
				}
				else block();
			}
		});
		//test2();
	}
	
	public static void test() {
		String query = "requete_foaf.sparql"; // fichier contenant la requête
		//String query = "requete.sparql";
		Model model = ModelFactory.createDefaultModel();
		try {
			//model.read(new FileInputStream("ABOX.n3"),null, "TURTLE");	
			model.read(new FileInputStream("foaf.n3"),null, "TURTLE");
			runSelectQuery(query, model);
		} catch (FileNotFoundException e) {
		e.printStackTrace();
		}
	}
	
	public static void test2() {
		String query = "requete_distante.sparql"; // fichier contenant la requête
		runSelectQueryDistance(query);
	}
	
	public static void runSelectQuery(String qfilename, Model model) {
		Query query = QueryFactory.read(qfilename);
		QueryExecution queryExecution = QueryExecutionFactory.create(query, model);
		ResultSet r = queryExecution.execSelect();
		ResultSetFormatter.out(System.out,r);
		queryExecution.close();
	}
	
	public static void runSelectQueryDistance(String qfilename) {
		Query query = QueryFactory.read(qfilename);
		System.setProperty("http.proxyHost","proxyweb.utc.fr");
		System.setProperty("http.proxyPort","3128");
		System.out.println("Query sent");
		QueryExecution queryExecution = QueryExecutionFactory.sparqlService( "http://linkedgeodata.org/sparql", query);
		ResultSet r = queryExecution.execSelect();
		ResultSetFormatter.out(System.out,r);
		queryExecution.close();
	}
}

